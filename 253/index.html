<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YouRMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


  <style>
  body {
    font-family: 'Inter', sans-serif;

  }


/* ----------- Navbar Modern Light Theme ----------- */
.navbar {
  background: #ffffff;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
  position: sticky;
  top: 0;
  z-index: 1000;
  width : 100%;
  padding: 0.75rem 1.5rem;
}

.navbar-container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
}

.logo {
  font-size: 1.6rem;
  font-weight: 700;
  color: #111827;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  letter-spacing: -0.5px;
}

.menu {
  display: flex;
  align-items: center;
  gap: 1.2rem;
}

.menu a {
  text-decoration: none;
  color: #374151;
  font-weight: 500;
  font-size: 1rem;
  transition: color 0.2s ease;
}
.menu a:hover {
  color: #1d4ed8;
}

.menu button {
  padding: 0.45rem 1rem;
  background-color: #1d4ed8;
  color: #ffffff;
  font-weight: 500;
  border: none;
  border-radius: 8px;
  font-size: 0.95rem;
  cursor: pointer;
  transition: background 0.2s ease;
}
.menu button:hover {
  background-color: #2563eb;
}

/* Hamburger */
.hamburger {
  display: none;
  font-size: 1.6rem;
  color: #374151;
  cursor: pointer;
}

#menu-toggle {
  display: none;
}

@media (max-width: 768px) {
  .menu {
    display: none;
    width: 100%;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
    background-color: #ffffff;
    padding: 1rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    border-radius: 0.5rem;
  }

  #menu-toggle:checked + .hamburger + .menu {
    display: flex;
  }

  .hamburger {
    display: block;
  }
}







    /* --- Variables & Reset --- */
    :root {
      --bg-page: #f4f6f9;
      --bg-panel: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #555555;
      --accent: #0077cc;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-strong: rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --transition: 0.3s ease;
    }
    *, *::before, *::after {
      margin: 0; padding: 0; box-sizing: border-box;
      transition: var(--transition);
    }
    html { font-size: 16px; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      align-items: center;

    }







  
    /* --- Headings --- */
    h1 {
      font-size: 2.5rem;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    h2, h3 {
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.25rem; }
  
    /* --- Panel Wrappers --- */
    .selected-container,
    #daily-schedule-summary,
    #schedule-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 2rem;
    }
  
    /* --- Daily Summary --- */
    #daily-schedule-summary {
      background: var(--bg-panel);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      box-shadow: 0 4px 8px var(--shadow-light);
    }
    #daily-schedule-summary h3 {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
      display: inline-block;
      padding-bottom: 0.25rem;
      margin-bottom: 1rem;
    }
    #daily-schedule-summary p {
      color: var(--text-secondary);
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }
  
    /* --- Selected Courses --- */
    .selected-container h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }
    .selected-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap: 1rem;
    }
    .selected-card {
      background: var(--bg-panel);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: 0 6px 12px var(--shadow-light);
      position: relative;
    }
    .selected-card:hover {
      box-shadow: 0 8px 16px var(--shadow-strong);
      transform: translateY(-3px);
    }
    .selected-card h3 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .selected-card p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0.3rem 0;
    }
    .selected-card .delete-btn {
      position: absolute;
      top: 1rem; right: 1rem;
      background: none; border: none;
      font-size: 1.1rem; color: #e74c3c;
      cursor: pointer;
    }
    .selected-card .delete-btn:hover {
      color: #c0392b;
    }
  
    /* --- Full Schedule --- */
    #schedule-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    .course {
      background: var(--bg-panel);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow-light);
    }
    .course h2 {
      background: var(--accent);
      color: #fff;
      padding: 0.75rem 1rem;
      font-size: 1.25rem;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: var(--bg-panel);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 4px 8px var(--shadow-light);
      position: relative;
    }
    .card:hover {
      box-shadow: 0 6px 16px var(--shadow-strong);
      transform: translateY(-2px);
    }
    .card input[type="checkbox"] {
      position: absolute;
      top: 1rem; right: 1rem;
      transform: scale(1.2);
    }
    .info span {
      display: block;
      margin: 0.3rem 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .tag {
      font-weight: 600;
      color: var(--accent);
      margin-right: 0.2rem;
    }
  
    /* --- Responsive --- */
    @media (max-width: 600px) {
      h1 { font-size: 1.9rem; }
      .course h2 { font-size: 1.1rem; }
    }

    /* --- Floating Button --- */
    #add-course-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: var(--accent);
      color: #a9e3eb;
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      font-size: 2rem;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px var(--shadow-light);
      cursor: pointer;
      transition: background 0.3s;
      z-index:1000;
    }
    #add-course-btn:hover {
      background: #005fa3;
    }




    #app-content {
  all: initial;
  font-family: 'Inter', sans-serif;
}

/* Re-enable just the styles you want for #app-content */
#app-content h1,
#app-content h2,
#app-content h3,
#app-content p,
#app-content button,
#app-content input,
#app-content div {
  all: unset;
  font-family: 'Inter', sans-serif;
  box-sizing: border-box;
}

/* Now re-apply your custom layout styles inside #app-content */
#app-content .selected-container,
#app-content #daily-schedule-summary,
#app-content #schedule-container {
  width: 100%;
  max-width: 1200px;
  margin-bottom: 2rem;
}

/* You can continue all your scoped custom CSS under #app-content */



footer {
         /*   margin-top: 20px; */
            width: 100%;
            background-color: #2c3e50;
            color: #ffffff;
            padding: 10px; 
            text-align: center;
            font-size: 14px;
            border-radius: 8px;
         /*   margin-bottom:14%; */
    				
  position: fixed;
      bottom: 2rem; 
  					
  
  


        }
 
        footer a {
            color: #1abc9c;
            text-decoration: none;
            font-weight: bold;
        }
 
        footer a:hover {
            text-decoration: underline;
        }

    

  </style>
</head>
<body>


<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <img src="logo.png" alt="Logo" style="height: 40px; width: auto;" class="me-2">
      <!--- <span class="fw-bold text-primary fs-4">YouRMS</span>  -->
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto align-items-center">
        <li class="nav-item">
          <a class="nav-link" href="manual.html">Manual</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about.html">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="contact.html">Contact</a>
        </li>
        <li class="nav-item">
          <button onclick="restartApp()" class="btn btn-outline-primary ms-3">Restart App</button>
        </li>
      </ul>
    </div>
  </div>
</nav>



<br>





  <div id="daily-schedule-summary" style="display: none;"></div>

  <div class="selected-container" style="display: none;">
    <h1>Your Selected Courses</h1>
    <div class="selected-grid" id="selected-courses"></div>
  </div>
  
  <div id="schedule-container"></div>

  <button id="add-course-btn" title="Add Course Later">
    <i class="fas fa-plus"></i>
  </button>



<footer>
    Developed with ❤️ by <a href="https://fb.com/md.shahriar.alam.sikey" target="_blank">Shahriar</a>
</footer> 



  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // — DATA OBJECT — (initially empty; will be filled by fetching JSON files)
    let data = {};

    // — Teacher Full Names Map (unchanged) —
const teacherFull = {
  "AKA": "T.M. Abul Kalam Azad",
  "TBA": "To Be Announced",
  "MNMA": "Md. Nazmul Abdal",
  "RaiK": "Raihan Kibria",
  "FK": "Fatema Khan",
  "NTNH": "Nazifa Tasnin Hia",
  "MAP": "Md. Aktaruzzaman Pramanik",
  "FTZC": "Fariha-Tuz Zahra Chowdhury",
  "RS": "Rajia Sultana",
  "AmiS": "Amio Sadman",
  "IrM": "Iram Mehrin",
  "ShahA": "Shaheen Ara",
  "FHS": "Faheem HaSAn Shahed",
  "TazA": "Tazin Ahmed",

  // Newly added
  "AAhM": "Azaz Ahmed",
  "DMMH": "Md. Mahadhi Hasann",
  "KHH": "Kaiser Hamidul Huq",
  "MIUK": "Muhammed Ihsan-Ul-Kabir",
  "NeG": "Neha Ghose",
  "SAdA": "Barrister Saad Andalib Aaistu",
  "SQC": "Selima Quader Chowdhury",

  "AAMM": "Abdullah Al Mahmud",
  "DSWA": "Sarwar Ahmed",
  "KAMRH": "K.A.M. Rifat Hasan",
  "MK": "Moinak Kanungo",
  "NFH": "Nafia Haque",
  "SadK": "Sadia Khalid",
  "SRAL": "Syeda Reshma Akter Laboni",

  "AAR": "Ahmed Abidur Razzaque Khan (GED)",
  "DZUR": "Zoeb-Ur-Rahman",
  "KAS": "Kamar Ahmad Simon",
  "MKB": "Milon Kumar Bhattacharjee",
  "NIH": "Nishat Hamid",
  "SahH": "Sahadat Hossain",
  "SRZ": "Shamim Reza",

  "AB": "Abdul Baten",
  "EAZ": "Ekhtear Ahmed Zeeshan",
  "KKK": "Kabya Kritthika",
  "MKU": "Md Kamal Uddin",
  "NIUR": "Nayem Imtiaz Uddin Raju",
  "SahibH": "Sahib Hossain",
  "SSMJ": "Syeda Sadia Mehjabin (MSJ)",

  "ABM": "Abdul Mannan",
  "FDAK": "Ferdousi Ara Khatun",
  "KKS": "Krishna Kumar Saha",
  "MLM": "Md. LAwha Mahfuz",
  "NMK": "Naima Khatun",
  "SakH": "Sakib Hossain",
  "STHK": "Sk. Tasthekur Hossain Kowshik",

  "AFMM": "A.F.M. Moniruzzaman",
  "KM": "Kazi Madina",
  "MM": "Md. Muntasir Mamun",
  "NNE": "Nazmun Nur Eva",
  "SAT": "Shirin Akter",
  "SUAh": "Shamsuddin Ahamad",

  "KMT": "Kazi M. Tarique",
  "MMP": "Md. Masum Parvez",
  "NReza": "Nafees Reza",
  "SaZ": "Sameera Zaman",
  "SuR": "Sumon Rahman",

  "AMMR": "Al Mahmud Rumman",
  "FMS": "Faisal Mohammad Shahriar",
  "LA": "Laboni Akter",
  "NT": "Nusrat Tajkia (ENG)",
  "SDA": "Sadia Afrin",
  "SViA": "Suravi Akhter",

  "ANMFa": "Abu Noor Md Farukh",
  "GKZ": "GoLAm Kader Zilany",
  "MaHK": "Mahmud Hasan Khan",
  "MNUT": "Md Nizam Uddin Tanim",
  "SDas": "Shatabdi Das",
  "SWAK": "Shawon Ahmed Kabir",

  "AOMS": "A.O.M. Shamsuddoha",
  "HaI": "Haseeb Irfanullah",
  "MaiH": "Mainul Haque",
  "MoMH": "Mohammed Mozammel Huq",
  "NUA": "Nasir Uddin Ahmed",
  "SDH": "Sadia Haque",
  "TaF": "Tahura Farbin",

  "AR": "Arifa Ghani Rahman",
  "HBK": "Habiba Kibria",
  "MAIs": "Md. Aminul Islam",
  "MosH": "Mosharof Hossainin",
  "OA": "Oeshwik Ahmed",
  "TazA": "Tazin Ahmed",

  "ArI": "Arzoo Ismail",
  "HMR": "Syed Hasib M. Rahman",
  "MAJB": "Md. Arifujjaman Babu",
  "MRBR": "Md. Redwan Bin Rahman",
  "ORS": "Oliur Rahman Sun",
  "SharN": "Sharminur Nahar",
  "THR": "Tawhid Reaz, Coordinator EMBA",

  "ARS": "Asma Royhana Sarkar",
  "HRK": "Harunur Rashid Khan",
  "MaN": "Mahmudunnabi",
  "MRMA": "Miduri Rahman Atoshee",
  "PFQ": "Paromita Fairuz Quarishi",
  "SHJ": "Shahnaj Husne Jahan",
  "TJI": "Tahamina Jahan Imran",

  "ASAr": "Abu Sayeed Arif",
  "IH": "Imran Hossain",
  "MASQ": "M.Ali Siddiquee",
  "MSAC": "Md. Saiful Alam Chowdhury",
  "PH": "Parveen Huda",
  "ShS": "Shubhankar Shil",
  "TKDas": "Tusher Kanti Das",

  "ASMR": "Abu Saleh Mohammad Rafi",
  "MAWA": "Md. Anowarul Abedin",
  "MSH": "Md. Sazzad Hossainin",
  "PMR": "Parvez Mahmud Rajib",
  "SJMF": "Sanjana Mustafa",
  "TRM": "Tasnova Rahman",

  "ASU": "Ahsann Ullah",
  "ITH": "Irtifa Haasn",
  "MAzn": "Muhammad Aminuzzaman",
  "MSIK": "M Shahidul Islam Khondaker",
  "SJSQ": "Shah Jafor Sadeek Quaderi",
  "TRoy": "Tonoy Roy",

  "AT": "Anika Tahsin",
  "JFR": "Jannatul Ferdous Ruma",
  "MCy": "Mehek Chowdhury",
  "MSMM": "Mohammad Sultan Mahmud",
  "RHF": "Rubaiya Hafiz",
  "SKHS": "Sakib Hasan Siddiqui",
  "TSZK": "Towsif Zahin Khan",

  "ATIA": "Antara Ibnat Audhaya",
  "KAM": "Kader Abdul Muhammad",
  "MDI": "Md. Didarul Islam",
  "MSNR": "Md. Shahinur Rahman",
  "RKH": "Rakib Hasan",
  "SKTR": "Shawkat Tanveer Rahman",
  "UAJ": "Umana Anjalin",

  "AUK": "Anirudha Kahaly",
  "MdKH": "Md Kaviul Hossain",
  "MSS": "Md. Shawn Sheikh",
  "RMC": "Rafiq Um Munir Chowdhury",
  "SLA": "Sadia Lena Alfee",
  "UH": "Ummay Habiba",

  "AvH": "ABantee Harun",
  "MGK": "Mohammad Golam Kibria",
  "MTIs": "Muzhataba Tawkeer Islam",
  "SMJ": "Sirajum Munira Joti",
  "UKA": "Uttam Karmaker Aurko",

  "AzH": "Azizul Haque",
  "MHH": "Muhammad Hasibul Hasan",
  "MTUS": "Md. Taufiq Us Samad",
  "RSC": "Rukhsana Choudhury",
  "SMMR": "S M Mahbubur Rahman",
  "WA": "Wazir Ahmad",

  "BAK": "Begum Akter Kamal",
  "MHHr": "MH Haidar",
  "MUAh": "Mahtab Uddin Ahmed",
  "RWAIK": "Rezwan Al Islam Khan",
  "WFU": "Wahida Ferdose Urmi",

  "BCB": "Bikash Chandra Bhowmick",
  "MinUA": "Minhaz Uddin Ahmed",
  "MZRM": "Md Ziaur Rahman",
  "SA": "Shajedul ALAm",
  "WH": "Wahidur Habib",

  "DS": "Shourav Sikder",
  "NafM": "Nafees Monsoor",
  "SABQ": "SArkar Barbaq Quarmal",

  "NAJ": "Nayma Akhter Jahan",
  "SAC": "Shahana Afrose Chowdhury",

  "NaR": "Nadia Rahman",
  "NBS": "Nibras Bin SAyed"
};


    // — Exam Rules (unchanged) —
    const examRules = [
      { start: 8*60,    end: 9*60+20,  dayIdx:0, time:"08:00 - 10:00 am" },
      { start: 9*60+25, end:10*60+45,  dayIdx:0, time:"10:00 - 12:00 pm" },
      { start:10*60+50, end:12*60+10,  dayIdx:0, time:"12:00 - 02:00 pm" },
      { start:12*60+15, end:13*60+35,  dayIdx:0, time:"02:00 - 04:00 pm" },
      { start:13*60+40, end:15*60,     dayIdx:1, time:"08:00 - 10:00 am" },
      { start:15*60+5,  end:16*60+25,  dayIdx:1, time:"10:00 - 12:00 pm" },
      { start:16*60+30, end:17*60+50,  dayIdx:1, time:"12:00 - 02:00 pm" }
    ];

    // — State & Storage for Selected Courses (unchanged) —
    let selected = JSON.parse(localStorage.getItem("selectedCourses") || "{}");
    function saveSelected() {
      localStorage.setItem("selectedCourses", JSON.stringify(selected));
    }

    // — Utility Functions —
    function timeToMin(str) {
      let [hm, ap] = str.split(" ");
      let [h, m] = hm.split(":").map(Number);
      if (ap.toLowerCase() === "pm" && h !== 12) h += 12;
      if (ap.toLowerCase() === "am" && h === 12) h = 0;
      return h * 60 + m;
    }
    function parseTimeRange(r) {
      if (!r || typeof r !== 'string') return [NaN, NaN]; 

      r = r.replace(/\s+/g, ' ').trim();

      let [s, e] = r.split(" - ").map(x => x.trim()),
          m = e.match(/(am|pm)/i)?.[0].toLowerCase();

      if (m) {
        if (!/(am|pm)/i.test(s)) s += " " + m; 
        if (!/(am|pm)/i.test(e)) e += " " + m; 
      }

      let start = timeToMin(s),
          end = timeToMin(e);

      if (isNaN(start) || isNaN(end)) {
        console.error(`Invalid time range: ${r}`);
        return [NaN, NaN];
      }
      
      if (start > end) start -= 12 * 60; 
      
      return [start, end];
    }
    
    // Modified extractDays to consider lab status and teacher's name
    function extractDays(courseObj) { 
      const isLab = courseObj.isLab; 
      if (isLab) {
        const teacherDayMatch = courseObj.teacher.match(/\(([A-Za-z]+)\)/);
        if (teacherDayMatch && teacherDayMatch[1]) {
          const dayMap = {
            'S': 'Sun', 'M': 'Mon', 'T': 'Tue', 'W': 'Wed', 'Th': 'Thu', 'F': 'Fri', 'Sa': 'Sat'
          };
          const abbreviation = teacherDayMatch[1];
          if (dayMap[abbreviation]) {
            return [dayMap[abbreviation]]; 
          }
        }
      }
      // Fallback for non-labs or labs without teacher day info
      if (courseObj.days.includes("<mark>")) {
        let tmp = document.createElement("div"); tmp.innerHTML = courseObj.days;
        return [...tmp.querySelectorAll("mark")].map(x => x.textContent.trim());
      }
      return courseObj.days.split("&").map(x => x.trim());
    }







    



    
    // New function to merge adjacent time slots for labs
    function mergeTimeSlots(timeSlotStrings) {
      if (!Array.isArray(timeSlotStrings) || timeSlotStrings.length === 0) {
        return [];
      }

      const parsedSlots = timeSlotStrings.map(slot => {
        const [start, end] = parseTimeRange(slot);
        return { original: slot, start, end };
      }).filter(slot => !isNaN(slot.start) && !isNaN(slot.end));

      if (parsedSlots.length === 0) {
        return [];
      }

      parsedSlots.sort((a, b) => a.start - b.start);

      const merged = [];
      let currentMerge = parsedSlots[0];

      for (let i = 1; i < parsedSlots.length; i++) {
        const nextSlot = parsedSlots[i];
        if (nextSlot.start <= currentMerge.end + 5) { 
          currentMerge.end = Math.max(currentMerge.end, nextSlot.end); 
        } else {
          merged.push({ start: currentMerge.start, end: currentMerge.end });
          currentMerge = nextSlot; 
        }
      }
      merged.push({ start: currentMerge.start, end: currentMerge.end }); 

      const formatMinToTime = (min) => {
        let hh = Math.floor(min / 60);
        let mm = min % 60;
        let period = "am";
        if (hh >= 12) period = "pm";
        if (hh > 12) hh -= 12;
        if (hh === 0) hh = 12; 
        return `${String(hh).padStart(2, '0')}:${String(mm).padStart(2, '0')} ${period}`;
      };

      return merged.map(slot => `${formatMinToTime(slot.start)} - ${formatMinToTime(slot.end)}`);
    }

    









    

    // Modified findConflict to handle multiple time slots and use updated extractDays
    function findConflict(newE, courseKey) {
      const newETimeSlots = Array.isArray(newE.time) ? newE.time : [newE.time];
      const nd = extractDays(newE); 

      for (let c in selected) {
        if (c === courseKey) continue; 

        let e = selected[c]; 
        const existingTimeSlots = Array.isArray(e.time) ? e.time : [e.time];
        const ed = extractDays(e); 

        for (const newSlotStr of newETimeSlots) {
          let [ns, ne] = parseTimeRange(newSlotStr);
          if (isNaN(ns) || isNaN(ne)) continue; 

          for (const existingSlotStr of existingTimeSlots) {
            let [es, ee] = parseTimeRange(existingSlotStr);
            if (isNaN(es) || isNaN(ee)) continue; 

            let day = nd.find(d => ed.includes(d)); 
            if (day && ns < ee && es < ne) { 
              let os = Math.max(ns, es),
                  oe = Math.min(ne, ee),
                  fmt = m => {
                    let hh = Math.floor(m/60), mm = m % 60, pp = hh >= 12;
                    if (hh > 12) hh -= 12;
                    if (hh === 0) hh = 12;
                    return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${pp ? 'pm' : 'am'}`;
                  };
              return { course: c, section: e.section, day, time: `${fmt(os)} - ${fmt(oe)}` };
            }
          }
        }
      }
      return false;
    }

    // — DOM Elements —
    const selContainer = document.querySelector(".selected-container");
    const selGrid = document.getElementById("selected-courses");
    const summaryContainer = document.getElementById("daily-schedule-summary");
    const schedContainer = document.getElementById("schedule-container");

    // — RENDERING SELECTED COURSES PANEL (Updated for examInfo logic and new data structure) —
    function renderSelected() {
      selGrid.innerHTML = "";
      for (let k in selected) {
        let e = selected[k],
            isLab = e.isLab, 
            times = Array.isArray(e.time) ? e.time.join(", ") : e.time,
            examInfo = isLab
                ? "No exam"
                : (() => {
                    let [st] = parseTimeRange(Array.isArray(e.time) ? e.time[0] : e.time), 
                        rule = examRules.find(r => r.start === st);
                    if (!rule) return "Exam time TBD";
                    let day = extractDays(e)[rule.dayIdx] || "TBD"; 
                    return `Exam: ${day}, ${rule.time}`;
                  })(),
            card = document.createElement("div");

        card.className = "selected-card";
        card.innerHTML = `
          <h3>${k}</h3>
          <p>Section: ${e.section}</p>
          <p>Room: ${e.room}</p>
          <p>Teacher: ${e.teacher}</p>
          <p>Days: ${e.days}</p>
          <p>Time: ${times}</p>
          <p><strong>${examInfo}</strong></p>
          <button class="delete-btn"><i class="fas fa-trash"></i></button>
        `;
        card.querySelector(".delete-btn").onclick = () => {
          Swal.fire({
            icon: 'warning', title: 'Remove Course?',
            text: `Delete ${k}?`, showCancelButton: true,
            confirmButtonText: 'Yes', cancelButtonText: 'No'
          }).then(res => {
            if (res.isConfirmed) {
              delete selected[k];
              saveSelected();
              renderSelected();
              renderSchedule();
              Swal.fire({
                icon: 'success',
                title: 'Deleted',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
          });
        };
        selGrid.appendChild(card);
      }
      renderDailyScheduleSummary();
      updatePanelsVisibility();
    }

    // — DAILY SUMMARY (Updated to use new data structure and extractDays) —
    function renderDailyScheduleSummary() {
      const summaryContainer = document.getElementById("daily-schedule-summary");
      if (!summaryContainer) return;

      const dayTimes = {};

      for (let key in selected) {
        const entry = selected[key]; 
        const timeSlots = Array.isArray(entry.time) ? entry.time : [entry.time];
        const classDays = extractDays(entry); 

        for (let day of classDays) {
          if (!dayTimes[day]) {
            dayTimes[day] = [];
          }
          timeSlots.forEach(slot => {
            const [start, end] = parseTimeRange(slot); 
            dayTimes[day].push([start, end]);
          });
        }
      }

      const formatTime = (min) => {
        let hh = Math.floor(min / 60),
            mm = min % 60,
            ap = hh >= 12 ? "pm" : "am";
        if (hh > 12) hh -= 12;
        if (hh === 0) hh = 12;
        return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")} ${ap}`;
      };

      summaryContainer.innerHTML = "<h3>Daily Class Summary</h3>";
      Object.entries(dayTimes).forEach(([day, times]) => {
        const sortedTimes = times.sort((a, b) => a[0] - b[0]);
        const earliest = sortedTimes[0][0];
        const latest = sortedTimes[sortedTimes.length - 1][1];

        summaryContainer.innerHTML += `<p><strong>${day}:</strong> ${formatTime(earliest)} - ${formatTime(latest)}</p>`;
      });
    }

    // — RENDER FULL SCHEDULE (Updated to use new data structure and set isLab) —
    function renderSchedule() {
      schedContainer.innerHTML = "";
      for (let courseKey in data) { 
        let box = document.createElement("div");
        box.className = "course";
        box.innerHTML = `<h2>${courseKey}</h2><div class="card-container"></div>`;
        let cc = box.querySelector(".card-container");

        data[courseKey].forEach(entry => { 
          let isSel = selected[courseKey]?.section === entry.section,
              card = document.createElement("div");
          card.className = "card";
          
          const displayTime = Array.isArray(entry.time) ? entry.time.join(", ") : entry.time;

          card.innerHTML = `
            <input type="checkbox" ${isSel ? "checked" : ""}>
            <div class="info">
              <span class="tag">Section:</span> ${entry.section}
              <span class="tag">Room:</span> ${entry.room}
              <span class="tag">Teacher:</span> ${entry.teacher} - ${teacherFull[entry.teacher.split(" ")[0]] || "Unknown"}
              <span class="tag">Days:</span> ${entry.days}
              <span class="tag">Time:</span> ${displayTime}
            </div>
          `;
          let cb = card.querySelector("input");
          cb.onchange = () => {
            let newE = entry; 

            if (!cb.checked) {
              delete selected[courseKey];
              saveSelected();
              renderSelected();
              renderSchedule();
              return Swal.fire({
                icon: 'success',
                title: 'Removed',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
            
            let conf = findConflict(newE, courseKey); 
            if (conf) {
              cb.checked = false;
              return Swal.fire({
                icon: 'error',
                title: 'Conflict',
                html: `Clashes with <strong>${conf.course} Sec ${conf.section}</strong><br>
                       On <strong>${conf.day}</strong> at <strong>${conf.time}</strong>`
              });
            }
            if (selected[courseKey] && selected[courseKey].section !== newE.section) {
              return Swal.fire({
                icon: 'warning',
                title: 'Replace Section?',
                text: `You have Sec ${selected[courseKey].section}. Replace with Sec ${newE.section}?`,
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
              }).then(res => {
                if (res.isConfirmed) {
                  selected[courseKey] = newE; 
                  saveSelected();
                  renderSelected();
                  renderSchedule();
                  Swal.fire({
                    icon: 'success',
                    title: 'Replaced',
                    toast: true,
                    position: 'top',
                    timer: 1200,
                    showConfirmButton: false
                  });
                } else {
                  cb.checked = false;
                }
              });
            } else {
              selected[courseKey] = newE; 
              saveSelected();
              renderSelected();
              renderSchedule();
              Swal.fire({
                icon: 'success',
                title: 'Saved',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
          };
          cc.appendChild(card);
        });

        schedContainer.appendChild(box);
      }
    }

    // — SHOW/HIDE PANELS BASED ON SELECTION (unchanged) —
    function updatePanelsVisibility() {
      const hasSelection = Object.keys(selected).length > 0;
      summaryContainer.style.display = hasSelection ? "" : "none";
      selContainer.style.display = hasSelection ? "" : "none";
    }

    // Enhanced Data Validation and Normalization
    function normalizeTimeFormat(time) {
      if (!time || typeof time !== 'string') return null;

      time = time.replace(/\s+/g, ' ').trim();

      if (!/(am|pm)/i.test(time)) {
        const [start, end] = time.split('-').map(t => t.trim());
        const startHour = parseInt(start.split(':')[0], 10);
        const endHour = parseInt(end.split(':')[0], 10);

        if (startHour >= 8 && startHour < 12) {
          time = `${start} am - ${end} am`;
        } else if (startHour >= 12 || endHour >= 12) {
          time = `${start} pm - ${end} pm`;
        }
      }

      return time;
    }

    // Modified validateAndNormalizeData to return objects and include isLab
    function validateAndNormalizeData(courseData) {
      const normalizedData = {};

      for (let courseKey in courseData) {
        if (!Array.isArray(courseData[courseKey])) {
          console.error(`Invalid data for course ${courseKey}: Expected an array.`);
          continue;
        }

        const sectionsMap = {}; // Use a map to group by normalized section

        courseData[courseKey].forEach(entry => {
          if (!Array.isArray(entry) || entry.length < 5) {
            console.error(`Invalid entry in ${courseKey}:`, entry);
            return; 
          }

          let rawSection = entry[0] || 'Unknown Section';
          let normalizedSection = rawSection.replace(/L$/i, ''); 

          const isLabEntry = courseKey.toLowerCase().includes("lab") || rawSection.toLowerCase().includes("l");

          let timeSlots = [];
          if (entry[4].includes(",")) {
            timeSlots = entry[4].split(',').map(t => normalizeTimeFormat(t.trim()));
          } else {
            timeSlots = [normalizeTimeFormat(entry[4])];
          }

          if (sectionsMap[normalizedSection]) {
            sectionsMap[normalizedSection].time = sectionsMap[normalizedSection].time.concat(timeSlots);
          } else {
            sectionsMap[normalizedSection] = {
              section: rawSection, 
              room: entry[1] || 'Unknown Room',
              teacher: entry[2] || 'Unknown Teacher',
              days: entry[3] || 'Unknown Days',
              time: timeSlots, 
              isLab: isLabEntry,
              courseKey: courseKey
            };
          }
        });

        normalizedData[courseKey] = Object.values(sectionsMap).map(sectionEntry => {
          if (sectionEntry.isLab) { 
            sectionEntry.time = mergeTimeSlots(sectionEntry.time);
          }
          // Ensure time is always an array
          if (!Array.isArray(sectionEntry.time)) {
             sectionEntry.time = [sectionEntry.time];
          }
          return sectionEntry;
        });
      }

      return normalizedData;
    }

    // — LOAD A SINGLE COURSE JSON BY ID — 
    async function loadCourseJSON(courseId) {
      try {
        let response = await fetch(`${courseId}.json`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        let json = await response.json();

        const validatedData = validateAndNormalizeData(json);

        for (let key in validatedData) {
          data[key] = validatedData[key]; 
        }
        return true;
      } catch (err) {
        console.error(`Failed to load ${courseId}.json:`, err);
        return false;
      }
    }

    // — PROMPT USER TO ADD COURSES ON FIRST VISIT —
    async function promptForCourses() {
      let added = [];
      while (true) {
        let { value: courseId } = await Swal.fire({
          title: 'Add a course',
          input: 'text',
          inputPlaceholder: 'Enter course ID (e.g. CSE 2101)',
          showCancelButton: true,
          inputValidator: (value) => {
            if (!value) return 'Course ID cannot be empty';
            return null;
          }
        });
        if (!courseId) break; 
        courseId = courseId.trim();
        let success = await loadCourseJSON(courseId);
        if (success) {
          added.push(courseId);
          Swal.fire({
            icon: 'success',
            title: `${courseId}.json loaded`,
            toast: true,
            position: 'top',
            timer: 1200,
            showConfirmButton: false
          });
        } else {
          await Swal.fire({
            icon: 'error',
            title: `Could not find ${courseId}.json`,
            text: 'Please check the filename and try again.'
          });
        }
        let { isConfirmed } = await Swal.fire({
          icon: 'question',
          title: 'Add another course?',
          showCancelButton: true,
          confirmButtonText: 'Yes',
          cancelButtonText: 'No'
        });
        if (!isConfirmed) break;
      }
      if (added.length > 0) {
        let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
        let unique = Array.from(new Set([...stored, ...added]));
        localStorage.setItem('addedCourses', JSON.stringify(unique));
      }
      toggleAddCourseButton(true); 
    }

    // Add a floating button to allow adding courses later
    function toggleAddCourseButton(show) {
      const addCourseBtn = document.getElementById("add-course-btn");
      addCourseBtn.style.display = show ? "flex" : "none";
    }

    // Add event listener to the floating button
    document.getElementById("add-course-btn").addEventListener("click", async () => {
      await promptForCourses();
      renderSelected();
      renderSchedule();
    });

    // — LOAD ALL COURSES FROM localStorage (for subsequent visits) —
    async function loadAllStoredCourses() {
      let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
      for (let cid of stored) {
        await loadCourseJSON(cid);
      }
    }

    // — MAIN INITIALIZATION — 
    (async function init() {
      let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
      if (stored.length === 0) {
        await promptForCourses();
      } else {
        toggleAddCourseButton(true); 
      }
      await loadAllStoredCourses();
      renderSelected();
      renderSchedule();
    })();

  </script>
</body>
</html>
<script>
    // Function to restart the app
function restartApp() {
  Swal.fire({
    icon: 'warning',
    title: 'Restart App?',
    text: 'This will reset all data and reload the app.',
    showCancelButton: true,
    confirmButtonText: 'Yes, restart',
    cancelButtonText: 'Cancel'
  }).then(result => {
    if (result.isConfirmed) {
      localStorage.clear();
      location.reload();
    }
  });
}


  </script>









