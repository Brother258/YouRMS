<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Class Schedule</title>
  <!-- Google Font, Font Awesome & SweetAlert2 -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
  <style>
    /* --- Variables & Reset --- */
    :root {
      --bg-page: #f4f6f9;
      --bg-panel: #ffffff;
      --text-primary: #2c3e50;
      --text-secondary: #555555;
      --accent: #0077cc;
      --shadow-light: rgba(0, 0, 0, 0.05);
      --shadow-strong: rgba(0, 0, 0, 0.1);
      --radius: 8px;
      --transition: 0.3s ease;
    }
    *, *::before, *::after {
      margin: 0; padding: 0; box-sizing: border-box;
      transition: var(--transition);
    }
    html { font-size: 16px; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-page);
      color: var(--text-primary);
      display: flex; flex-direction: column; align-items: center;
      padding: 2rem 1rem;
    }
  
    /* --- Headings --- */
    h1 {
      font-size: 2.5rem;
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    h2, h3 {
      color: var(--text-primary);
      margin-bottom: 0.75rem;
    }
    h2 { font-size: 1.75rem; }
    h3 { font-size: 1.25rem; }
  
    /* --- Panel Wrappers --- */
    .selected-container,
    #daily-schedule-summary,
    #schedule-container {
      width: 100%;
      max-width: 1200px;
      margin-bottom: 2rem;
    }
  
    /* --- Daily Summary --- */
    #daily-schedule-summary {
      background: var(--bg-panel);
      border-radius: var(--radius);
      padding: 1.25rem 1.5rem;
      box-shadow: 0 4px 8px var(--shadow-light);
    }
    #daily-schedule-summary h3 {
      color: var(--accent);
      border-bottom: 2px solid var(--accent);
      display: inline-block;
      padding-bottom: 0.25rem;
      margin-bottom: 1rem;
    }
    #daily-schedule-summary p {
      color: var(--text-secondary);
      margin: 0.4rem 0;
      font-size: 0.95rem;
    }
  
    /* --- Selected Courses --- */
    .selected-container h1 {
      font-size: 2rem;
      color: var(--accent);
      margin-bottom: 1rem;
    }
    .selected-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
      gap: 1rem;
    }
    .selected-card {
      background: var(--bg-panel);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: 0 6px 12px var(--shadow-light);
      position: relative;
    }
    .selected-card:hover {
      box-shadow: 0 8px 16px var(--shadow-strong);
      transform: translateY(-3px);
    }
    .selected-card h3 {
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }
    .selected-card p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin: 0.3rem 0;
    }
    .selected-card .delete-btn {
      position: absolute;
      top: 1rem; right: 1rem;
      background: none; border: none;
      font-size: 1.1rem; color: #e74c3c;
      cursor: pointer;
    }
    .selected-card .delete-btn:hover {
      color: #c0392b;
    }
  
    /* --- Full Schedule --- */
    #schedule-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    .course {
      background: var(--bg-panel);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow-light);
    }
    .course h2 {
      background: var(--accent);
      color: #fff;
      padding: 0.75rem 1rem;
      font-size: 1.25rem;
    }
    .card-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px,1fr));
      gap: 1rem;
      padding: 1rem;
    }
    .card {
      background: var(--bg-panel);
      border-left: 4px solid var(--accent);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 4px 8px var(--shadow-light);
      position: relative;
    }
    .card:hover {
      box-shadow: 0 6px 16px var(--shadow-strong);
      transform: translateY(-2px);
    }
    .card input[type="checkbox"] {
      position: absolute;
      top: 1rem; right: 1rem;
      transform: scale(1.2);
    }
    .info span {
      display: block;
      margin: 0.3rem 0;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    .tag {
      font-weight: 600;
      color: var(--accent);
      margin-right: 0.2rem;
    }
  
    /* --- Responsive --- */
    @media (max-width: 600px) {
      h1 { font-size: 1.9rem; }
      .course h2 { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

  <div id="daily-schedule-summary" style="display: none;"></div>

  <!-- Selected Courses -->
  <div class="selected-container" style="display: none;">
    <h1>Your Selected Courses</h1>
    <div class="selected-grid" id="selected-courses"></div>
  </div>

  <h1>Class Schedule</h1>
  <!-- Full Schedule -->
  <div id="schedule-container"></div>

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    // — DATA OBJECT — (initially empty; will be filled by fetching JSON files)
    let data = {};

    // — Teacher Full Names Map (unchanged) —
    const teacherFull = {
      "AKA": "T.M. Abul Kalam Azad",
      "TBA": "To Be Announced",
      "MNMA": "Md. Nazmul Abdal",
      "RaiK": "Raihan Kibria",
      "FK": "Fatema Khan",
      "NTNH": "Nazifa Tasnin Hia",
      "MAP": "Md. Aktaruzzaman Pramanik",
      "FTZC": "Fariha-Tuz Zahra Chowdhury",
      "RS": "Rajia Sultana",
      "AmiS": "Amio Sadman",
      "IrM": "Iram Mehrin",
      "ShahA": "Shaheen Ara",
      "FHS": "Faheem HaSAn Shahed",
      "TazA": "Tazin Ahmed"
    };

    // — Exam Rules (unchanged) —
    const examRules = [
      { start: 8*60,    end: 9*60+20,  dayIdx:0, time:"08:00 - 10:00 am" },
      { start: 9*60+25, end:10*60+45,  dayIdx:0, time:"10:00 - 12:00 pm" },
      { start:10*60+50, end:12*60+10,  dayIdx:0, time:"12:00 - 02:00 pm" },
      { start:12*60+15, end:13*60+35,  dayIdx:0, time:"02:00 - 04:00 pm" },
      { start:13*60+40, end:15*60,     dayIdx:1, time:"08:00 - 10:00 am" },
      { start:15*60+5,  end:16*60+25,  dayIdx:1, time:"10:00 - 12:00 pm" },
      { start:16*60+30, end:17*60+50,  dayIdx:1, time:"12:00 - 02:00 pm" }
    ];

    // — State & Storage for Selected Courses (unchanged) —
    let selected = JSON.parse(localStorage.getItem("selectedCourses") || "{}");
    function saveSelected() {
      localStorage.setItem("selectedCourses", JSON.stringify(selected));
    }

    // — Utility Functions (unchanged) —
    function timeToMin(str) {
      let [hm, ap] = str.split(" ");
      let [h, m] = hm.split(":").map(Number);
      if (ap.toLowerCase() === "pm" && h !== 12) h += 12;
      if (ap.toLowerCase() === "am" && h === 12) h = 0;
      return h * 60 + m;
    }
    function parseTimeRange(r) {
      let [s, e] = r.split(" - ").map(x => x.trim()),
          m = e.match(/(am|pm)/i)?.[0].toLowerCase();
      if (m) {
        if (!/(am|pm)/i.test(s)) s += " " + m;
        if (!/(am|pm)/i.test(e)) e += " " + m;
      }
      let start = timeToMin(s),
          end   = timeToMin(e);
      if (start > end) start -= 12 * 60;
      return [start, end];
    }
    function extractDays(str) {
      if (str.includes("<mark>")) {
        let tmp = document.createElement("div"); tmp.innerHTML = str;
        return [...tmp.querySelectorAll("mark")].map(x => x.textContent.trim());
      }
      return str.split("&").map(x => x.trim());
    }
    function findConflict(newE, courseKey) {
      let [ns, ne] = parseTimeRange(newE.time), nd = extractDays(newE.days);
      for (let c in selected) {
        if (c === courseKey) continue;
        let e = selected[c],
            [es, ee] = parseTimeRange(e.time),
            ed = extractDays(e.days),
            day = nd.find(d => ed.includes(d));
        if (day && ns < ee && es < ne) {
          let os = Math.max(ns, es),
              oe = Math.min(ne, ee),
              fmt = m => {
                let hh = Math.floor(m/60), mm = m % 60, pp = hh >= 12;
                if (hh > 12) hh -= 12;
                if (hh === 0) hh = 12;
                return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')} ${pp ? 'pm' : 'am'}`;
              };
          return { course: c, section: e.section, day, time: `${fmt(os)} - ${fmt(oe)}` };
        }
      }
      return false;
    }

    // — DOM Elements —
    const selContainer = document.querySelector(".selected-container");
    const selGrid = document.getElementById("selected-courses");
    const summaryContainer = document.getElementById("daily-schedule-summary");
    const schedContainer = document.getElementById("schedule-container");

    // — RENDERING SELECTED COURSES PANEL (unchanged) —
    function renderSelected() {
      selGrid.innerHTML = "";
      for (let k in selected) {
        let e = selected[k],
            examInfo = k.includes("Lab")
              ? "No exam"
              : (() => {
                  let [st] = parseTimeRange(e.time),
                      rule = examRules.find(r => r.start === st);
                  if (!rule) return "Exam time TBD";
                  let day = extractDays(e.days)[rule.dayIdx] || "TBD";
                  return `Exam: ${day}, ${rule.time}`;
                })(),
            card = document.createElement("div");
        card.className = "selected-card";
        card.innerHTML = `
          <h3>${k}</h3>
          <p>Section: ${e.section}</p>
          <p>Room: ${e.room}</p>
          <p>Teacher: ${e.teacher}</p>
          <p>Days: ${e.days}</p>
          <p>Time: ${e.time}</p>
          <p><strong>${examInfo}</strong></p>
          <button class="delete-btn"><i class="fas fa-trash"></i></button>
        `;
        card.querySelector(".delete-btn").onclick = () => {
          Swal.fire({
            icon: 'warning', title: 'Remove Course?',
            text: `Delete ${k}?`, showCancelButton: true,
            confirmButtonText: 'Yes', cancelButtonText: 'No'
          }).then(res => {
            if (res.isConfirmed) {
              delete selected[k];
              saveSelected();
              renderSelected();
              renderSchedule();
              Swal.fire({
                icon: 'success',
                title: 'Deleted',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
          });
        };
        selGrid.appendChild(card);
      }
      renderDailyScheduleSummary();
      updatePanelsVisibility();
    }

    // — DAILY SUMMARY (unchanged except innerHTML generation) —
    function renderDailyScheduleSummary() {
      const dayTimes = {};
      for (let key in selected) {
        const { time, days } = selected[key];
        const [start, end] = parseTimeRange(time);
        const classDays = extractDays(days);
        for (let day of classDays) {
          if (!dayTimes[day]) dayTimes[day] = [];
          dayTimes[day].push([start, end]);
        }
      }

      const formatTime = (min) => {
        let hh = Math.floor(min / 60),
            mm = min % 60,
            ap = hh >= 12 ? "pm" : "am";
        if (hh > 12) hh -= 12;
        if (hh === 0) hh = 12;
        return `${String(hh).padStart(2, "0")}:${String(mm).padStart(2, "0")} ${ap}`;
      };

      summaryContainer.innerHTML = "<h3>Daily Class Summary</h3>";
      Object.entries(dayTimes).forEach(([day, times]) => {
        const startTimes = times.map(t => t[0]);
        const endTimes = times.map(t => t[1]);
        const earliest = Math.min(...startTimes);
        const latest = Math.max(...endTimes);
        summaryContainer.innerHTML += `<p><strong>${day}:</strong> ${formatTime(earliest)} - ${formatTime(latest)}</p>`;
      });
    }

    // — RENDER FULL SCHEDULE (unchanged except reading from dynamic `data`) —
    function renderSchedule() {
      schedContainer.innerHTML = "";
      for (let course in data) {
        let box = document.createElement("div");
        box.className = "course";
        box.innerHTML = `<h2>${course}</h2><div class="card-container"></div>`;
        let cc = box.querySelector(".card-container");

        data[course].forEach(([sec, room, tch, days, time]) => {
          let isSel = selected[course]?.section === sec,
              card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <input type="checkbox" ${isSel ? "checked" : ""}>
            <div class="info">
              <span class="tag">Section:</span> ${sec}
              <span class="tag">Room:</span> ${room}
              <span class="tag">Teacher:</span> ${tch} - ${teacherFull[tch.split(" ")[0]] || "Unknown"}
              <span class="tag">Days:</span> ${days}
              <span class="tag">Time:</span> ${time}
            </div>
          `;
          let cb = card.querySelector("input");
          cb.onchange = () => {
            let newE = { section: sec, room, teacher: tch, days, time };
            if (!cb.checked) {
              delete selected[course];
              saveSelected();
              renderSelected();
              renderSchedule();
              return Swal.fire({
                icon: 'success',
                title: 'Removed',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
            let conf = findConflict(newE, course);
            if (conf) {
              cb.checked = false;
              return Swal.fire({
                icon: 'error',
                title: 'Conflict',
                html: `Clashes with <strong>${conf.course} Sec ${conf.section}</strong><br>
                       On <strong>${conf.day}</strong> at <strong>${conf.time}</strong>`
              });
            }
            if (selected[course] && selected[course].section !== sec) {
              return Swal.fire({
                icon: 'warning',
                title: 'Replace Section?',
                text: `You have Sec ${selected[course].section}. Replace with Sec ${sec}?`,
                showCancelButton: true,
                confirmButtonText: 'Yes',
                cancelButtonText: 'No'
              }).then(res => {
                if (res.isConfirmed) {
                  selected[course] = newE;
                  saveSelected();
                  renderSelected();
                  renderSchedule();
                  Swal.fire({
                    icon: 'success',
                    title: 'Replaced',
                    toast: true,
                    position: 'top',
                    timer: 1200,
                    showConfirmButton: false
                  });
                } else {
                  cb.checked = false;
                }
              });
            } else {
              selected[course] = newE;
              saveSelected();
              renderSelected();
              renderSchedule();
              Swal.fire({
                icon: 'success',
                title: 'Saved',
                toast: true,
                position: 'top',
                timer: 1200,
                showConfirmButton: false
              });
            }
          };
          cc.appendChild(card);
        });

        schedContainer.appendChild(box);
      }
    }

    // — SHOW/HIDE PANELS BASED ON SELECTION (unchanged) —
    function updatePanelsVisibility() {
      const hasSelection = Object.keys(selected).length > 0;
      summaryContainer.style.display = hasSelection ? "" : "none";
      selContainer.style.display = hasSelection ? "" : "none";
    }

    // — LOAD A SINGLE COURSE JSON BY ID — 
    async function loadCourseJSON(courseId) {
      try {
        // Attempt to fetch "<courseId>.json" from same directory
        let response = await fetch(`${courseId}.json`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        let json = await response.json();
        // Merge into data (the JSON’s top‐level keys might be full course names)
        for (let key in json) {
          data[key] = json[key];
        }
        return true;
      } catch (err) {
        console.error(`Failed to load ${courseId}.json:`, err);
        return false;
      }
    }

    // — PROMPT USER TO ADD COURSES ON FIRST VISIT —
    async function promptForCourses() {
      let added = [];
      // Keep asking until user cancels or leaves input blank
      while (true) {
        let { value: courseId } = await Swal.fire({
          title: 'Add a course',
          input: 'text',
          inputPlaceholder: 'Enter course ID (e.g. CSE 2101) without .json',
          showCancelButton: true,
          inputValidator: (value) => {
            if (!value) return 'Course ID cannot be empty';
            return null;
          }
        });
        if (!courseId) break; // user cancelled or left blank
        courseId = courseId.trim();
        let success = await loadCourseJSON(courseId);
        if (success) {
          added.push(courseId);
          Swal.fire({
            icon: 'success',
            title: `${courseId}.json loaded`,
            toast: true,
            position: 'top',
            timer: 1200,
            showConfirmButton: false
          });
        } else {
          await Swal.fire({
            icon: 'error',
            title: `Could not find ${courseId}.json`,
            text: 'Please check the filename and try again.'
          });
        }
        // Ask if they want to add another
        let { isConfirmed } = await Swal.fire({
          icon: 'question',
          title: 'Add another course?',
          showCancelButton: true,
          confirmButtonText: 'Yes',
          cancelButtonText: 'No'
        });
        if (!isConfirmed) break;
      }
      // Save added IDs to localStorage so next time we skip prompting
      if (added.length > 0) {
        let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
        let unique = Array.from(new Set([...stored, ...added]));
        localStorage.setItem('addedCourses', JSON.stringify(unique));
      }
    }

    // — LOAD ALL COURSES FROM localStorage (for subsequent visits) —
    async function loadAllStoredCourses() {
      let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
      for (let cid of stored) {
        await loadCourseJSON(cid);
      }
    }

    // — MAIN INITIALIZATION — 
    (async function init() {
      let stored = JSON.parse(localStorage.getItem('addedCourses') || '[]');
      if (stored.length === 0) {
        // First visit (no courses saved yet)
        await promptForCourses();
      }
      // Load any previously saved course JSONs (including those just added)
      await loadAllStoredCourses();
      // Now that "data" is populated, render the page
      renderSelected();
      renderSchedule();
    })();

  </script>
</body>
</html>